# Apache SSL Virtual Host Configuration for Sci-Bono LMS
# Production HTTPS Configuration

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName sci-bono-lms.com
    ServerAlias www.sci-bono-lms.com
    DocumentRoot /var/www/html
    DirectoryIndex index.php index.html
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/sci-bono-lms.crt
    SSLCertificateKeyFile /etc/ssl/private/sci-bono-lms.key
    SSLCertificateChainFile /etc/ssl/certs/sci-bono-lms-chain.crt
    
    # Modern SSL Configuration
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE+AESGCM:ECDHE+CHACHA20:DHE+AESGCM:DHE+CHACHA20:!aNULL:!MD5:!DSS
    SSLHonorCipherOrder on
    
    # SSL Security Headers
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy for enhanced security
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https:; media-src 'self'; object-src 'none'; child-src 'self'; form-action 'self'; base-uri 'self'; upgrade-insecure-requests;"
    
    # Remove Server signature
    ServerTokens Prod
    ServerSignature Off
    
    # SSL Session Configuration
    SSLSessionCache shmcb:/var/run/apache2/ssl_scache(512000)
    SSLSessionCacheTimeout 300
    SSLUseStapling on
    SSLStaplingCache shmcb:/var/run/apache2/ssl_stapling_cache(128000)
    
    # Directory configuration (same as HTTP but with SSL)
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # Enable compression
        <IfModule mod_deflate.c>
            SetOutputFilter DEFLATE
            SetEnvIfNoCase Request_URI \
                \.(?:gif|jpe?g|png)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI \
                \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
        </IfModule>
        
        # Cache static files
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType text/css "access plus 1 month"
            ExpiresByType application/javascript "access plus 1 month"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/ico "access plus 1 year"
            ExpiresByType image/icon "access plus 1 year"
            ExpiresByType text/plain "access plus 1 month"
            ExpiresByType application/pdf "access plus 1 month"
        </IfModule>
        
        # Rewrite rules for clean URLs
        <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # API routing
            RewriteCond %{REQUEST_URI} ^/api/(.*)$
            RewriteRule ^api/(.*)$ app/API/router.php [QSA,L]
            
            # Remove .php extension
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteRule ^([^\.]+)$ $1.php [NC,L]
            
            # Protect sensitive files
            RewriteRule ^(config|docker|secrets|tests|tools|vendor)/ - [F,L]
            RewriteRule \.(env|log|sql|bak|backup)$ - [F,L]
        </IfModule>
    </Directory>
    
    # Protect sensitive directories
    <Directory "/var/www/html/config">
        Require all denied
    </Directory>
    
    <Directory "/var/www/html/secrets">
        Require all denied
    </Directory>
    
    <Directory "/var/www/html/vendor">
        Require all denied
    </Directory>
    
    <Directory "/var/www/html/tests">
        Require all denied
    </Directory>
    
    <Directory "/var/www/html/docker">
        Require all denied
    </Directory>
    
    # Allow access to public assets
    <Directory "/var/www/html/public">
        Options -Indexes
        AllowOverride None
        Require all granted
    </Directory>
    
    # Performance monitoring dashboard (restrict access in production)
    <LocationMatch "^/app/Controllers/PerformanceDashboardController\.php">
        # Restrict by IP in production
        Require ip 127.0.0.1
        Require ip 192.168.0.0/16
        Require ip 10.0.0.0/8
        
        # Basic authentication
        AuthType Basic
        AuthName "Sci-Bono LMS Performance Dashboard"
        AuthUserFile /var/www/html/config/.htpasswd
        Require valid-user
    </LocationMatch>
    
    # API Documentation (restrict access)
    <LocationMatch "^/docs/.*">
        # Restrict by IP in production
        Require ip 127.0.0.1
        Require ip 192.168.0.0/16
        Require ip 10.0.0.0/8
        
        # Basic authentication
        AuthType Basic
        AuthName "Sci-Bono LMS API Documentation"
        AuthUserFile /var/www/html/config/.htpasswd
        Require valid-user
    </LocationMatch>
    
    # API rate limiting
    <IfModule mod_evasive24.c>
        DOSHashTableSize    4096
        DOSPageCount        10
        DOSPageInterval     1
        DOSSiteCount        25
        DOSSiteInterval     1
        DOSBlockingPeriod   120
        DOSLogDir           /var/log/apache2/evasive
    </IfModule>
    
    # SSL Logging
    ErrorLog ${APACHE_LOG_DIR}/sci-bono-lms-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/sci-bono-lms-ssl-access.log combined
    CustomLog ${APACHE_LOG_DIR}/sci-bono-lms-ssl-request.log "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"
    
    # Performance logging
    CustomLog ${APACHE_LOG_DIR}/sci-bono-lms-ssl-performance.log "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" %D %{SSL_PROTOCOL}x %{SSL_CIPHER}x"
</VirtualHost>

# Intermediate SSL Configuration
SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder off
SSLSessionTickets off

# Modern SSL protocols only
SSLProtocol -all +TLSv1.2 +TLSv1.3

# OCSP Stapling
SSLUseStapling On
SSLStaplingCache "shmcb:logs/stapling-cache(150000)"
</IfModule>

# Redirect HTTP to HTTPS
<VirtualHost *:80>
    ServerName sci-bono-lms.com
    ServerAlias www.sci-bono-lms.com
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Health check endpoint (allow HTTP for load balancer)
    RewriteCond %{REQUEST_URI} ^/health$
    RewriteRule ^health$ app/Controllers/PerformanceDashboardController.php?action=health [QSA,L]
    
    ErrorLog ${APACHE_LOG_DIR}/sci-bono-lms-redirect-error.log
    CustomLog ${APACHE_LOG_DIR}/sci-bono-lms-redirect-access.log combined
</VirtualHost>