const CONFIG={useModernRouting:void 0===window.USE_MODERN_ROUTING||window.USE_MODERN_ROUTING,endpoints:{modern:{signin:(window.BASE_URL||"/Sci-Bono_Clubhoue_LMS/")+"api/v1/attendance/signin",signout:(window.BASE_URL||"/Sci-Bono_Clubhoue_LMS/")+"api/v1/attendance/signout",search:(window.BASE_URL||"/Sci-Bono_Clubhoue_LMS/")+"api/v1/attendance/search",stats:(window.BASE_URL||"/Sci-Bono_Clubhoue_LMS/")+"api/v1/attendance/stats"},legacy:{signin:(window.BASE_URL||"")+"app/Controllers/attendance_routes.php?action=signin",signout:(window.BASE_URL||"")+"app/Controllers/attendance_routes.php?action=signout",search:(window.BASE_URL||"")+"app/Controllers/attendance_routes.php?action=search",stats:(window.BASE_URL||"")+"app/Controllers/attendance_routes.php?action=stats"}},autoRefreshInterval:3e5,maxFailedAttempts:5,searchDelay:300};function getEndpoints(){return CONFIG.useModernRouting?CONFIG.endpoints.modern:CONFIG.endpoints.legacy}let modal,closeBtn,signinForm,errorMessage,errorText,submitBtn,btnText,loadingSpinner,searchInput,clearBtn,noResults,signinCards,memberCount,signOutModal,currentUserId=null,searchTimeout=null;function initializeDOMElements(){modal=document.getElementById("signin-modal"),closeBtn=document.getElementById("close-signin-modal"),signinForm=document.getElementById("signin-form"),errorMessage=document.getElementById("error-message")||document.querySelector(".incorrectPassword"),errorText=document.getElementById("error-text"),submitBtn=document.querySelector(".submit-btn"),btnText=document.querySelector(".btn-text"),loadingSpinner=document.querySelector(".loading-spinner"),searchInput=document.getElementById("search-input")||document.getElementById("search"),clearBtn=document.getElementById("clear-search"),noResults=document.getElementById("no-results"),signinCards=document.getElementById("signin-cards")||document.querySelector(".signInUserCards"),memberCount=document.getElementById("member-count"),signOutModal=document.getElementById("signOut-modal"),signOutModal&&(signOutModal.style.display="none")}function performSearch(){if(!searchInput)return;const e=searchInput.value.toLowerCase().trim(),n=document.querySelectorAll(".userSignin_card, .user-card");let t=0;if(n.forEach(n=>{if(n.closest("#signout-cards")||n.closest(".signOutUserCards"))return;const o=((n.getAttribute("data-search-terms")||"")+" "+(n.querySelector(".userName h3, .user-name")?.textContent||"")+" "+(n.querySelector(".userName h6, .user-fullname")?.textContent||"")+" "+(n.querySelector(".userRole p, .user-role")?.textContent||"")).toLowerCase().includes(e)||""===e;n.style.display=o?"flex":"none",o&&t++}),noResults){const n=0===t&&""!==e;noResults.style.display=n?"flex":"none"}clearBtn&&(clearBtn.style.display=e?"flex":"none")}function clearSearch(){if(!searchInput)return;searchInput.value="",clearBtn&&(clearBtn.style.display="none");document.querySelectorAll(".userSignin_card, .user-card").forEach(e=>{e.closest("#signout-cards")||e.closest(".signOutUserCards")||(e.style.display="flex")}),noResults&&(noResults.style.display="none"),searchInput.focus()}function debouncedSearch(){clearTimeout(searchTimeout),searchTimeout=setTimeout(performSearch,CONFIG.searchDelay)}function closeSigninModal(){if(!modal)return;modal.style.display="none",modal.classList.remove("active"),document.body.style.overflow="",errorMessage&&(errorMessage.style.display="none",errorMessage.classList.remove("show")),signinForm&&signinForm.reset();const e=document.getElementById("modal-user-name"),n=document.getElementById("modal-user-role");e&&(e.textContent="Loading..."),n&&(n.textContent="MEMBER",n.className="modal-user-role member"),resetSubmitButton(),currentUserId=null}function showSigninModal(e){if(!modal)return;currentUserId=e;const n=document.querySelector(`[data-user-id="${e}"]`);if(n){const e=n.querySelector(".user-name")?.textContent||"Unknown User",t=n.querySelector(".user-role")?.textContent||"Member",o=n.querySelector(".user-role")?.className||"",s=document.getElementById("modal-user-name"),r=document.getElementById("modal-user-role");s&&(s.textContent=e),r&&(r.textContent=t,r.className="modal-user-role",o.includes("admin")?r.classList.add("admin"):o.includes("mentor")?r.classList.add("mentor"):o.includes("member")&&r.classList.add("member"))}modal.style.display="block",modal.classList.add("active"),document.body.style.overflow="hidden";const t=document.getElementById("userId");t&&(t.value=e),setTimeout(()=>{const e=document.getElementById("password");e&&e.focus()},100)}function resetSubmitButton(){submitBtn&&(submitBtn.disabled=!1,submitBtn.classList.remove("loading"),btnText&&(btnText.style.display="inline"),loadingSpinner&&(loadingSpinner.style.display="none"))}function showError(e){if(console.error("Signin Error:",e),errorText&&(errorText.textContent=e),errorMessage){errorMessage.style.display="flex",errorMessage.classList.add("show");const e=document.querySelector(".modal-content");e&&(e.classList.add("error","shake"),setTimeout(()=>{e.classList.remove("error","shake")},500))}}function showSuccessToast(e){const n=document.getElementById("success-toast");if(n){const t=n.querySelector("span");t&&(t.textContent=e),n.classList.add("show"),setTimeout(()=>{n.classList.remove("show")},3e3)}else signOutModal&&(signOutModal.style.display="block",setTimeout(()=>{signOutModal.style.display="none"},3e3))}function signIn(e){showSigninModal(e)}function signInPrompt(e){showSigninModal(e)}function sendSignInRequest(e,n){if(!submitBtn)return;submitBtn.disabled=!0,submitBtn.classList.add("loading"),btnText&&(btnText.style.display="none"),loadingSpinner&&(loadingSpinner.style.display="inline-block"),errorMessage&&(errorMessage.style.display="none");const t=getEndpoints();console.log("Attempting signin for user:",e),console.log("Using endpoint:",t.signin),console.log("Modern routing:",CONFIG.useModernRouting);const o=new FormData;o.append("user_id",e),o.append("password",n),fetch(t.signin,{method:"POST",body:o}).then(e=>{if(console.log("Response status:",e.status),console.log("Response headers:",e.headers),!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=e.headers.get("content-type");return n&&n.includes("application/json")?e.json():e.text().then(e=>{throw console.error("Non-JSON response:",e),new Error("Server returned non-JSON response")})}).then(e=>{if(console.log("Signin response:",e),e.success)closeSigninModal(),showSuccessToast("Successfully signed in!"),setTimeout(()=>{window.location.reload()},1e3);else{showError(e.message||"Sign in failed. Please try again."),resetSubmitButton();const n=document.getElementById("password");n&&(n.value="",n.focus())}}).catch(e=>{console.error("Fetch error:",e),showError("Connection error. Please check your internet connection and try again."),resetSubmitButton()})}function handleSignInResponse(e){"valid"===e.trim()?(console.log("Sign-in successful!"),closeSigninModal(),showSuccessToast("Successfully signed in!"),setTimeout(()=>{window.location.reload()},1e3)):showError("Invalid password. Please try again.")}function signOut(e){if(!confirm("Are you sure you want to sign out?"))return;const n=getEndpoints();console.log("Attempting signout for user:",e),console.log("Using endpoint:",n.signout),console.log("Modern routing:",CONFIG.useModernRouting);const t=new FormData;t.append("user_id",e),fetch(n.signout,{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const n=e.headers.get("content-type");return n&&n.includes("application/json")?e.json():e.text().then(e=>{throw console.error("Non-JSON response:",e),new Error("Server returned non-JSON response")})}).then(n=>{if(n.success){showSuccessToast("Successfully signed out!");const n=document.getElementById("userCard"+e);n&&(n.style.transition="opacity 0.3s ease",n.style.opacity="0",setTimeout(()=>{n.remove(),updateMemberCount()},300)),setTimeout(()=>{window.location.reload()},1e3)}else alert(n.message||"Failed to sign out. Please try again.")}).catch(e=>{console.error("Signout error:",e),alert("An error occurred. Please try again.")})}function updateMemberCount(){if(!memberCount)return;const e=document.querySelectorAll("#signout-cards .user-card:not(.no-members), .signOutUserCards .userSignin_card").length;memberCount.textContent=e}function setupEventListeners(){searchInput&&(searchInput.addEventListener("input",debouncedSearch),searchInput.addEventListener("keyup",function(e){"Escape"===e.key&&clearSearch()})),clearBtn&&clearBtn.addEventListener("click",clearSearch),closeBtn&&closeBtn.addEventListener("click",closeSigninModal),modal&&modal.addEventListener("click",function(e){e.target===modal&&closeSigninModal()}),signinForm&&signinForm.addEventListener("submit",function(e){if(e.preventDefault(),!currentUserId)return void showError("No user selected");const n=document.getElementById("password")?.value;n?sendSignInRequest(currentUserId,n):showError("Password is required")}),document.addEventListener("keydown",function(e){"Escape"===e.key&&modal&&("block"===modal.style.display||modal.classList.contains("active"))&&closeSigninModal()}),document.addEventListener("click",function(e){if(e.target.classList.contains("signInBtn")||e.target.closest(".signInBtn")){e.preventDefault();const n=e.target.classList.contains("signInBtn")?e.target:e.target.closest(".signInBtn"),t=n.getAttribute("data-user-id")||n.getAttribute("onclick")?.match(/\d+/)?.[0];t&&signIn(parseInt(t))}})}document.addEventListener("DOMContentLoaded",function(){console.log("Initializing attendance system..."),console.log("Endpoints configured:",CONFIG.endpoints),initializeDOMElements(),setupEventListeners(),updateMemberCount(),searchInput&&searchInput.focus(),console.log("Attendance system initialized successfully")}),setInterval(()=>{console.log("Auto-refreshing page..."),window.location.reload()},CONFIG.autoRefreshInterval),window.onclick=function(e){modal&&e.target==modal&&closeSigninModal()},window.signIn=signIn,window.signOut=signOut,window.signInPrompt=signInPrompt,window.handleSignInResponse=handleSignInResponse,window.testEndpoint=function(){console.log("Testing signin endpoint..."),fetch(CONFIG.endpoints.signin).then(e=>(console.log("Endpoint test - Status:",e.status),e.text())).then(e=>{console.log("Endpoint test - Response:",e)}).catch(e=>{console.error("Endpoint test - Error:",e)})};