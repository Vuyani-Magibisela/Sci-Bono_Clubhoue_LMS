function validateEmail(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())}function validatePhone(e){return/^(\+\d{1,2}\s?)?\(?\d{3}\)?[\s.-]?\d{3}[\s.-]?\d{4}$/.test(String(e))}function showError(e,t){const n=document.getElementById(e),r=document.getElementById(`${e}-error`);n.classList.add("error"),r.textContent=t,r.style.display="block"}function hideError(e){const t=document.getElementById(e),n=document.getElementById(`${e}-error`);t.classList.remove("error"),n.style.display="none"}function showNotification(e,t){const n=document.getElementById("notification");n.className="notification",n.classList.add(`notification-${e}`),n.textContent=t,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll(".tab"),t=document.querySelectorAll(".tab-content");e.forEach(n=>{n.addEventListener("click",function(){const n=this.getAttribute("data-tab");e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),this.classList.add("active"),document.getElementById(n).classList.add("active")})})});const registrationForm=document.getElementById("registration-form");registrationForm.addEventListener("submit",function(e){e.preventDefault();let t=!0;""===document.getElementById("name").value.trim()?(showError("name","Please enter your name"),t=!1):hideError("name");""===document.getElementById("surname").value.trim()?(showError("surname","Please enter your surname"),t=!1):hideError("surname");const n=document.getElementById("age").value;""===n||isNaN(n)||n<5||n>100?(showError("age","Please enter a valid age (5-100)"),t=!1):hideError("age");""===document.getElementById("grade-school").value.trim()?(showError("grade-school","Please enter your grade school"),t=!1):hideError("grade-school");""===document.getElementById("parent-name").value.trim()?(showError("parent-name","Please enter parent name"),t=!1):hideError("parent-name");""===document.getElementById("parent-surname").value.trim()?(showError("parent-surname","Please enter parent surname"),t=!1):hideError("parent-surname");const r=document.getElementById("email").value.trim();""!==r&&validateEmail(r)?hideError("email"):(showError("email","Please enter a valid email address"),t=!1);const i=document.getElementById("phone").value.trim();if(""!==i&&validatePhone(i)?hideError("phone"):(showError("phone","Please enter a valid phone number"),t=!1),t){console.log("Form is valid, submitting data...");const e=document.getElementById("register-btn");e.classList.add("loading"),e.disabled=!0;const t=new FormData(registrationForm);fetch("../../handlers/visitors-handler.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{e.classList.remove("loading"),e.disabled=!1,t.success?(showNotification("success","Registration successful!"),registrationForm.reset(),loadVisitors()):showNotification("error",t.message||"Registration failed. Please try again.")}).catch(t=>{e.classList.remove("loading"),e.disabled=!1,showNotification("error","An error occurred. Please try again."),console.error("Error:",t)})}});const signInForm=document.getElementById("signin-form");signInForm.addEventListener("submit",function(e){e.preventDefault();let t=!0;const n=document.getElementById("signin-email").value.trim();if(""!==n&&validateEmail(n)?hideError("signin-email"):(showError("signin-email","Please enter a valid email address"),t=!1),t){const e=document.getElementById("signin-btn");e.classList.add("loading"),e.disabled=!0;const t=new FormData(signInForm);t.append("action","signin"),fetch("../../handlers/visitors-handler.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{e.classList.remove("loading"),e.disabled=!1,t.success?(showNotification("success","Sign in successful!"),signInForm.reset(),loadVisitors()):showNotification("error",t.message||"Sign in failed. Please try again.")}).catch(t=>{e.classList.remove("loading"),e.disabled=!1,showNotification("error","An error occurred. Please try again."),console.error("Error:",t)})}});const signOutForm=document.getElementById("signout-form");signOutForm.addEventListener("submit",function(e){e.preventDefault();let t=!0;const n=document.getElementById("signout-email").value.trim();if(""!==n&&validateEmail(n)?hideError("signout-email"):(showError("signout-email","Please enter a valid email address"),t=!1),t){const e=document.getElementById("signout-btn");e.classList.add("loading"),e.disabled=!0;const t=new FormData(signOutForm);t.append("action","signout"),fetch("../../handlers/visitors-handler.php",{method:"POST",body:t}).then(e=>e.json()).then(t=>{e.classList.remove("loading"),e.disabled=!1,t.success?(showNotification("success","Sign out successful!"),signOutForm.reset(),loadVisitors()):showNotification("error",t.message||"Sign out failed. Please try again.")}).catch(t=>{e.classList.remove("loading"),e.disabled=!1,showNotification("error","An error occurred. Please try again."),console.error("Error:",t)})}});let currentPage=1;const recordsPerPage=10;function loadVisitors(e=1,t="all",n=""){currentPage=e;const r=document.getElementById("visitors-list");r.innerHTML='<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>',fetch(`visitors-handler.php?action=list&page=${e}&filter=${t}&search=${n}`).then(e=>e.json()).then(e=>{e.success?(r.innerHTML="",0===e.visitors.length?r.innerHTML='<tr><td colspan="6" style="text-align: center;">No visitors found</td></tr>':(e.visitors.forEach(e=>{let t="N/A";if(e.sign_out_time){const n=new Date(e.sign_in_time),r=new Date(e.sign_out_time)-n;t=`${Math.floor(r/36e5)}h ${Math.floor(r%36e5/6e4)}m`}const n=e.sign_out_time?'<span class="badge badge-completed">Completed</span>':'<span class="badge badge-active">Active</span>',i=document.createElement("tr");i.innerHTML=`\n                                <td>${e.name} ${e.surname}</td>\n                                <td>${e.email}</td>\n                                <td>${formatDateTime(e.sign_in_time)}</td>\n                                <td>${e.sign_out_time?formatDateTime(e.sign_out_time):"Still Present"}</td>\n                                <td>${t}</td>\n                                <td>${n}</td>\n                            `,r.appendChild(i)}),generatePagination(e.totalPages,currentPage))):r.innerHTML=`<tr><td colspan="6" style="text-align: center;">${e.message||"Failed to load visitors"}</td></tr>`}).catch(e=>{r.innerHTML='<tr><td colspan="6" style="text-align: center;">Error loading visitors</td></tr>',console.error("Error:",e)})}function formatDateTime(e){const t=new Date(e);return new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(t)}function generatePagination(e,t){const n=document.getElementById("pagination");if(n.innerHTML="",e>1){const e=document.createElement("a");e.innerHTML="&laquo;",e.href="#",t>1?e.addEventListener("click",e=>{e.preventDefault(),loadVisitors(t-1,getCurrentFilter(),getCurrentSearch())}):e.classList.add("disabled"),n.appendChild(e)}for(let r=1;r<=e;r++){const e=document.createElement("a");e.textContent=r,e.href="#",r===t&&e.classList.add("active"),e.addEventListener("click",e=>{e.preventDefault(),r!==t&&loadVisitors(r,getCurrentFilter(),getCurrentSearch())}),n.appendChild(e)}if(e>1){const r=document.createElement("a");r.innerHTML="&raquo;",r.href="#",t<e?r.addEventListener("click",e=>{e.preventDefault(),loadVisitors(t+1,getCurrentFilter(),getCurrentSearch())}):r.classList.add("disabled"),n.appendChild(r)}}function getCurrentFilter(){return document.getElementById("filter-status").value}function getCurrentSearch(){return document.getElementById("search-input").value.trim()}loadVisitors(1,getCurrentFilter(),getCurrentSearch());const searchInput=document.getElementById("search-input"),filterStatus=document.getElementById("filter-status");function debounce(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>e.apply(this,r),t)}}searchInput.addEventListener("input",debounce(function(){loadVisitors(1,getCurrentFilter(),getCurrentSearch())},500)),filterStatus.addEventListener("change",function(){loadVisitors(1,getCurrentFilter(),getCurrentSearch())});